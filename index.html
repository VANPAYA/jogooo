<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒœ â€” N5/N4 (AnÃ¡lise linha a linha)</title>

  <style>
    :root{
      --bg0:#070A10;
      --bg1:#0B1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.14);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,.70);
      --muted2: rgba(234,240,255,.55);

      --hue: 200; /* muda com JS */
      --a1: hsl(calc(var(--hue) + 10) 90% 62%);
      --a2: hsl(calc(var(--hue) - 20) 90% 58%);
      --a3: hsl(calc(var(--hue) + 55) 90% 60%);

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 26px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --jp: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", var(--sans);

      --fontScale: 1; /* controlado via JS */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(0,180,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 25%, rgba(255,80,220,.14), transparent 58%),
                  radial-gradient(900px 600px at 50% 92%, rgba(0,255,170,.10), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* Animated glow "aurora" */
    .aurora{
      position:fixed; inset:-20%;
      background:
        radial-gradient(closest-side at 20% 20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(closest-side at 80% 30%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(closest-side at 50% 80%, rgba(255,255,255,.06), transparent 60%),
        conic-gradient(from 230deg at 50% 50%,
          rgba(0,0,0,0),
          rgba(0,0,0,0),
          rgba(255,255,255,.10),
          rgba(0,0,0,0),
          rgba(255,255,255,.08),
          rgba(0,0,0,0)
        );
      filter: blur(34px) saturate(120%);
      opacity:.55;
      animation: drift 16s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes drift{
      0%   { transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(0deg); }
      50%  { transform: translate3d(2%,  2%, 0) scale(1.06) rotate(8deg); }
      100% { transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(0deg); }
    }

    /* Layout */
    .app{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      padding: 14px;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .panelHeader{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 0;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 14px;
      background:
        radial-gradient(80% 80% at 20% 20%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.14);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg,
        rgba(255,255,255,0),
        rgba(255,255,255,.18),
        rgba(255,255,255,0));
      transform: rotate(12deg);
      animation: sheen 3.8s ease-in-out infinite;
      opacity:.9;
    }
    @keyframes sheen{
      0%{ transform: translateX(-18%) rotate(12deg); }
      55%{ transform: translateX(18%) rotate(12deg); }
      100%{ transform: translateX(-18%) rotate(12deg); }
    }

    .brandTitle{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .brandTitle .name{
      font-weight: 800;
      letter-spacing: .3px;
      font-size: 14px;
      line-height: 1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandTitle .sub{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.20); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border-color: rgba(255,255,255,.20);
      position:relative;
      overflow:hidden;
    }
    .btnPrimary::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(80% 80% at 20% 10%, rgba(255,255,255,.18), transparent 60%),
                  linear-gradient(135deg, rgba(0,0,0,0), rgba(255,255,255,.06));
      opacity:.75;
      pointer-events:none;
    }

    .btnAccent{
      border-color: rgba(255,255,255,.20);
      background: linear-gradient(135deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .btnAccent::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(0,0,0,0), rgba(255,255,255,.12), rgba(0,0,0,0));
      opacity:.35;
      filter: blur(6px);
      pointer-events:none;
    }
    .btnAccent strong{
      background: linear-gradient(90deg, var(--a1), var(--a3));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }

    .content{
      padding: 14px 14px 16px;
      overflow:auto;
      min-height: 0;
    }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .col{ display:flex; flex-direction:column; gap: 10px; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{ grid-template-columns: 1fr; height:auto; overflow:visible; }
    }

    /* Inputs */
    .input, .select, .textarea{
      width: 100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      font-size: 13px;
    }
    .textarea{ min-height: 110px; resize: vertical; font-family: var(--mono); }
    .input::placeholder,.textarea::placeholder{ color: rgba(234,240,255,.40); }

    .tag{
      display:inline-flex;
      align-items:center;
      padding: 4px 9px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      gap: 6px;
      white-space:nowrap;
    }
    .tag b{ color: var(--text); }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .kpiCard{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .kpiCard .v{
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .kpiCard .l{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Library list */
    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .item:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .item.active{
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(135deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .itemTop{ display:flex; justify-content:space-between; align-items:flex-start; gap: 10px; }
    .itemTitle{
      font-weight: 900;
      font-size: 13px;
      line-height: 1.25;
      margin:0;
    }
    .itemDesc{
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Main header */
    .mainHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .hTitle{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 260px;
    }
    .hTitle h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .hTitle .meta{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      flex-wrap:wrap;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      border: 1px solid transparent;
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    /* Lines */
    .lineList{ display:flex; flex-direction:column; gap: 10px; margin-top: 12px; }
    .lineCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
    }
    .lineTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
    }
    .lineLeft{ min-width: 0; }
    .jp{
      font-family: var(--jp);
      font-size: calc(16px * var(--fontScale));
      font-weight: 800;
      line-height: 1.45;
      margin:0;
      word-break: break-word;
    }
    .reading{
      margin-top: 6px;
      font-size: calc(12px * var(--fontScale));
      color: var(--muted);
      font-family: var(--jp);
      line-height: 1.35;
      word-break: break-word;
    }
    .lineBadges{ display:flex; flex-direction:column; gap: 8px; align-items:flex-end; }
    .chk{
      display:flex; align-items:center; gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .chk input{ accent-color: var(--a1); }
    .lineActions{
      display:flex; gap: 8px; flex-wrap:wrap; margin-top: 10px;
    }

    .details{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.14);
      padding-top: 10px;
      display:none;
    }
    .lineCard.open .details{ display:block; }

    .pt{
      margin:0;
      color: var(--text);
      font-size: calc(13px * var(--fontScale));
      line-height: 1.55;
    }
    .notes{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .box{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px;
    }
    .boxTitle{
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
      margin-bottom: 6px;
    }
    .boxTitle b{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .box p{
      margin: 0;
      font-size: calc(13px * var(--fontScale));
      color: var(--text);
      line-height: 1.55;
      word-break: break-word;
    }

    /* Vocab */
    .vocabGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .vocabGrid{ grid-template-columns: 1fr; }
    }
    .vocabCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }
    .vocabCard .w{
      font-family: var(--jp);
      font-size: calc(16px * var(--fontScale));
      font-weight: 900;
      margin:0;
    }
    .vocabCard .r{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--jp);
    }
    .vocabCard .m{
      margin-top: 6px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.4;
    }
    .vocabRight{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:flex-end;
      justify-content:space-between;
      min-width: 120px;
    }

    /* Flashcards */
    .cardWrap{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 10px;
    }
    @media (max-width: 980px){
      .cardWrap{ grid-template-columns: 1fr; }
    }
    .flash{
      border: 1px solid rgba(255,255,255,.14);
      background: radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: 22px;
      padding: 16px;
      min-height: 220px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 10px;
      text-align:center;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .flash .front{
      font-family: var(--jp);
      font-size: calc(30px * var(--fontScale));
      font-weight: 1000;
      letter-spacing:.3px;
    }
    .flash .back{
      display:none;
      width: 100%;
      max-width: 520px;
    }
    .flash.revealed .back{ display:block; }
    .flash.revealed .hint{ display:none; }

    .flash .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }
    .flash .subline{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      font-family: var(--jp);
    }
    .flash .meaning{
      margin-top: 8px;
      color: var(--text);
      font-size: 14px;
      line-height: 1.45;
    }

    /* Quiz */
    .quizQ{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px;
    }
    .quizQ h3{ margin:0 0 10px; font-size: 14px; }
    .choices{ display:flex; flex-direction:column; gap: 8px; }
    .choice{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      display:flex; justify-content:space-between; gap: 10px;
    }
    .choice:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.20); }
    .choice.good{ border-color: rgba(0,255,170,.35); background: rgba(0,255,170,.10); }
    .choice.bad{ border-color: rgba(255,80,120,.35); background: rgba(255,80,120,.10); }
    .choice small{ color: var(--muted); }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 50;
    }
    .modal.open{ display:flex; }
    .modalCard{
      width: min(980px, 100%);
      max-height: 88vh;
      overflow:auto;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 14px;
    }
    .modalCard h2{ margin: 0 0 10px; font-size: 16px; }
    .modalCard .help{ color: var(--muted); font-size: 12px; margin: 0 0 12px; line-height: 1.45; }

    /* Focus mode */
    .focusMode body{ overflow:hidden; }
    .focus{
      position:fixed; inset:0;
      background: radial-gradient(1200px 700px at 20% 20%, rgba(0,180,255,.16), transparent 58%),
                  radial-gradient(900px 600px at 85% 30%, rgba(255,80,220,.12), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      z-index: 60;
      display:none;
      padding: 14px;
    }
    .focus.open{ display:block; }
    .focus .panel{ height: 100%; }

    /* tiny icons */
    .ic{ width: 14px; height: 14px; display:inline-block; }
    .ic svg{ width:100%; height:100%; fill: currentColor; opacity:.9; }
    .muted{ color: var(--muted); }
    .spacer{ height: 10px; }
    .hr{
      border:0;
      border-top: 1px solid rgba(255,255,255,.10);
      margin: 12px 0;
    }

    /* Ruby */
    ruby{ ruby-position: over; }
    rt{ font-size: 0.58em; color: rgba(234,240,255,.75); font-weight: 700; }
  </style>
</head>
<body>
  <div class="aurora"></div>

  <div class="app" id="app">
    <!-- LEFT / LIBRARY -->
    <section class="panel" id="leftPanel" aria-label="Biblioteca">
      <div class="panelHeader">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brandTitle">
            <div class="name">æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒœ</div>
            <div class="sub">N5 / N4 â€¢ anÃ¡lise linha a linha â€¢ progresso local</div>
          </div>
        </div>
        <div class="pill" title="Tema muda com o tempo">âš¡ <span id="themeLabel">hue</span></div>
      </div>

      <div class="content">
        <div class="col">
          <div class="row">
            <select class="select" id="levelFilter" title="Filtrar por nÃ­vel">
              <option value="ALL">NÃ­vel: Todos</option>
              <option value="N5">N5</option>
              <option value="N4">N4</option>
            </select>
            <button class="btn btnPrimary" id="btnNewText">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
              </span>
              Criar texto
            </button>
          </div>

          <input class="input" id="searchInput" placeholder="Buscar tÃ­tulo, JP ou palavra-chave..." />

          <div class="kpi" aria-label="Resumo">
            <div class="kpiCard">
              <div class="v" id="kpiTexts">0</div>
              <div class="l">Textos</div>
            </div>
            <div class="kpiCard">
              <div class="v" id="kpiLinesDone">0</div>
              <div class="l">Linhas revisadas</div>
            </div>
            <div class="kpiCard">
              <div class="v" id="kpiDeck">0</div>
              <div class="l">Deck (cards)</div>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="btnExport">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm7-18-5 5h3v6h4V7h3l-5-5z"/></svg>
              </span>
              Exportar
            </button>
            <button class="btn" id="btnImport">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M19 15v4H5v-4H3v6h18v-6h-2zM11 3v6H8l4 4 4-4h-3V3h-2z"/></svg>
              </span>
              Importar
            </button>
            <button class="btn" id="btnReset">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5a5 5 0 1 1-9.9-1h-2.02A7 7 0 1 0 12 6z"/></svg>
              </span>
              Reset parcial
            </button>
          </div>

          <div class="hr"></div>

          <div class="list" id="libraryList"></div>
          <div class="spacer"></div>
          <div class="muted" style="font-size:12px;line-height:1.45">
            Dica: clique em uma linha para abrir traduÃ§Ã£o, gramÃ¡tica e vocabulÃ¡rio. Marque como â€œrevisadaâ€ e o progresso fica salvo no seu navegador.
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT / READER -->
    <section class="panel" aria-label="Leitor">
      <div class="panelHeader">
        <div class="mainHeader" style="width:100%">
          <div class="hTitle">
            <h1 id="textTitle">Selecione um texto</h1>
            <div class="meta" id="textMeta"></div>
          </div>

          <div class="row">
            <div class="tabs" role="tablist" aria-label="Abas">
              <div class="tab active" data-tab="TAB_TEXT" role="tab">Texto</div>
              <div class="tab" data-tab="TAB_VOCAB" role="tab">VocabulÃ¡rio</div>
              <div class="tab" data-tab="TAB_FLASH" role="tab">Deck</div>
              <div class="tab" data-tab="TAB_QUIZ" role="tab">Quiz</div>
              <div class="tab" data-tab="TAB_NOTES" role="tab">Notas</div>
            </div>

            <button class="btn btnAccent" id="btnFocus">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H5v5zm10 9h-3v2h5v-5h-2v3zm0-14V5h-5v2h3v3h2z"/></svg>
              </span>
              <strong>Modo foco</strong>
            </button>
          </div>
        </div>
      </div>

      <div class="content" id="mainContent">
        <div id="emptyState" style="opacity:.95">
          <div class="box">
            <div class="boxTitle">
              <b>Comece por aqui</b>
              <span class="tag">ğŸ“Œ <b>N5</b> e <b>N4</b></span>
            </div>
            <p>
              Ã€ esquerda vocÃª tem a biblioteca de textos. Cada texto vem com anÃ¡lise linha a linha (JP, leitura, traduÃ§Ã£o, gramÃ¡tica e vocabulÃ¡rio).
              VocÃª tambÃ©m pode criar seus prÃ³prios textos e montar seu deck de flashcards.
            </p>
          </div>

          <div class="split" style="margin-top:10px">
            <div class="box">
              <div class="boxTitle"><b>Essenciais (jÃ¡ prontos)</b></div>
              <p>âœ… Filtro N5/N4 â€¢ ğŸ” Busca â€¢ ğŸ“š AnÃ¡lise linha a linha â€¢ â­ Favoritos â€¢ ğŸ§  Deck â€¢ ğŸ¯ Quiz â€¢ ğŸ“ Notas â€¢ ğŸ’¾ Tudo salvo no navegador</p>
            </div>
            <div class="box">
              <div class="boxTitle"><b>Controles rÃ¡pidos</b></div>
              <div class="row">
                <button class="btn" id="btnToggleFuri">Furigana: ON</button>
                <button class="btn" id="btnFontMinus">A-</button>
                <button class="btn" id="btnFontPlus">A+</button>
                <button class="btn" id="btnToggleReading">Leitura: ON</button>
              </div>
              <div class="muted" style="font-size:12px;margin-top:8px;line-height:1.4">
                Ajuste para leitura longa e revisÃ£o rÃ¡pida.
              </div>
            </div>
          </div>
        </div>

        <!-- tabs content -->
        <div id="tab_TEXT" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row">
              <button class="btn" id="btnToggleFuri2">Furigana: ON</button>
              <button class="btn" id="btnToggleReading2">Leitura: ON</button>
              <button class="btn" id="btnExpandAll">Abrir tudo</button>
              <button class="btn" id="btnCollapseAll">Fechar tudo</button>
            </div>
            <div class="row">
              <button class="btn" id="btnFontMinus2">A-</button>
              <button class="btn" id="btnFontPlus2">A+</button>
              <button class="btn" id="btnBookmark">â˜† Favoritar</button>
            </div>
          </div>

          <div class="lineList" id="lineList"></div>
        </div>

        <div id="tab_VOCAB" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>VocabulÃ¡rio do texto</b>
              <span class="tag">Clique em â€œ+ Deckâ€ para adicionar</span>
            </div>
            <p>O vocabulÃ¡rio abaixo Ã© agregado a partir das linhas (e vocÃª pode montar um deck com o que interessa).</p>
          </div>
          <div class="vocabGrid" id="vocabGrid"></div>
        </div>

        <div id="tab_FLASH" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Deck (flashcards)</b>
              <span class="tag">Spaced practice simples â€¢ local</span>
            </div>
            <p>Use â€œRevelarâ€ e marque sua confianÃ§a. O algoritmo Ã© leve (nÃ£o Ã© SM-2 completo), mas jÃ¡ dÃ¡ curva boa de revisÃ£o.</p>
          </div>

          <div class="cardWrap">
            <div class="flash" id="flashCard">
              <div class="front" id="flashFront">â€”</div>
              <div class="hint" id="flashHint">Clique em â€œRevelarâ€</div>
              <div class="back" id="flashBack">
                <div class="subline" id="flashReading">â€”</div>
                <div class="meaning" id="flashMeaning">â€”</div>
              </div>
            </div>

            <div class="col">
              <div class="row">
                <button class="btn btnPrimary" id="btnReveal">Revelar</button>
                <button class="btn" id="btnNext">PrÃ³ximo</button>
              </div>
              <div class="row">
                <button class="btn" id="btnRate1">1 â€¢ DifÃ­cil</button>
                <button class="btn" id="btnRate2">2 â€¢ Ok</button>
                <button class="btn" id="btnRate3">3 â€¢ FÃ¡cil</button>
              </div>

              <div class="box">
                <div class="boxTitle"><b>Status do deck</b></div>
                <p id="deckStatus" class="muted" style="font-size:12px;line-height:1.45">Adicione cards a partir da aba VocabulÃ¡rio.</p>
              </div>

              <div class="row">
                <button class="btn" id="btnClearDeck">Limpar deck</button>
              </div>
            </div>
          </div>
        </div>

        <div id="tab_QUIZ" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Quiz</b>
              <span class="tag">Vocab â†’ significado (PT)</span>
            </div>
            <p>Gere perguntas rÃ¡pidas com o vocabulÃ¡rio do texto atual (ou do deck).</p>
            <div class="row">
              <button class="btn btnPrimary" id="btnNewQuiz">Gerar quiz</button>
              <select class="select" id="quizSource" style="max-width:260px">
                <option value="TEXT">Fonte: VocabulÃ¡rio do texto</option>
                <option value="DECK">Fonte: Meu deck</option>
              </select>
              <select class="select" id="quizCount" style="max-width:200px">
                <option value="5">5 questÃµes</option>
                <option value="8" selected>8 questÃµes</option>
                <option value="12">12 questÃµes</option>
              </select>
            </div>
          </div>

          <div id="quizWrap"></div>
        </div>

        <div id="tab_NOTES" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Notas do texto</b>
              <span class="tag">Salvo automaticamente</span>
            </div>
            <p>Use este espaÃ§o para escrever insights, padrÃµes de gramÃ¡tica, frases Ãºteis, etc.</p>
            <textarea class="textarea" id="textNotes" placeholder="Ex.: ã€œãªãŒã‚‰ = enquanto; ã€œã¦ã—ã¾ã† nuance de arrependimento; etc."></textarea>
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="muted" style="font-size:12px">Auto-save ativo â€¢ sem servidor</div>
              <button class="btn" id="btnClearNotes">Limpar notas</button>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- Focus overlay -->
  <div class="focus" id="focusOverlay">
    <section class="panel">
      <div class="panelHeader">
        <div class="row">
          <button class="btn btnPrimary" id="btnExitFocus">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 14.83l-6.89 6.88-1.41-1.42L10.59 12 3.7 5.71 5.11 4.29 12 11.17l6.89-6.88z"/></svg>
            </span>
            Sair do foco
          </button>
          <div class="pill">Modo foco â€¢ leitura contÃ­nua</div>
        </div>
        <div class="row">
          <button class="btn" id="btnToggleFuriFocus">Furigana: ON</button>
          <button class="btn" id="btnToggleReadingFocus">Leitura: ON</button>
          <button class="btn" id="btnFontMinusFocus">A-</button>
          <button class="btn" id="btnFontPlusFocus">A+</button>
        </div>
      </div>
      <div class="content">
        <div class="muted" style="font-size:12px;line-height:1.45">
          Toque/clique em uma linha para abrir detalhes. Ideal para revisÃ£o longa.
        </div>
        <div class="lineList" id="focusLineList"></div>
      </div>
    </section>
  </div>

  <!-- Modal: New Text -->
  <div class="modal" id="modalNew">
    <div class="modalCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Adicionar texto personalizado</h2>
        <button class="btn" id="btnCloseModalNew">
          <span class="ic" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 14.83l-6.89 6.88-1.41-1.42L10.59 12 3.7 5.71 5.11 4.29 12 11.17l6.89-6.88z"/></svg>
          </span>
          Fechar
        </button>
      </div>
      <p class="help">
        Cole seu texto em japonÃªs (uma frase por linha). O site vai quebrar em linhas e vocÃª pode preencher leitura, traduÃ§Ã£o, gramÃ¡tica e vocab por linha (opcional).
        Tudo fica salvo localmente.
      </p>

      <div class="split">
        <div class="col">
          <label class="muted" style="font-size:12px">TÃ­tulo</label>
          <input class="input" id="newTitle" placeholder="Ex.: å‹ã ã¡ã¨æ˜ ç”»ã«è¡Œã" />
          <label class="muted" style="font-size:12px">NÃ­vel</label>
          <select class="select" id="newLevel">
            <option value="N5">N5</option>
            <option value="N4">N4</option>
          </select>
          <label class="muted" style="font-size:12px">DescriÃ§Ã£o</label>
          <input class="input" id="newDesc" placeholder="Ex.: Texto curto para praticar ã€œãŸã„, partÃ­culas e vocabulÃ¡rio bÃ¡sico." />
          <label class="muted" style="font-size:12px">Texto (uma linha por frase)</label>
          <textarea class="textarea" id="newRaw" placeholder="Ex.&#10;ä»Šæ—¥ã¯å‹ã ã¡ã¨æ˜ ç”»ã«è¡Œãã¾ã™ã€‚&#10;é§…ã§å¾…ã¡åˆã‚ã›ã¾ã™ã€‚"></textarea>
        </div>

        <div class="col">
          <div class="box">
            <div class="boxTitle"><b>ApÃ³s criar</b></div>
            <p>1) Selecione o texto na biblioteca<br>2) Clique em cada linha e adicione notas/gramÃ¡tica<br>3) Adicione palavras ao deck na aba VocabulÃ¡rio</p>
          </div>

          <div class="box">
            <div class="boxTitle"><b>Atalho</b></div>
            <p class="muted" style="font-size:12px;line-height:1.45">
              NÃ£o quer preencher tudo agora? Sem problema. Comece sÃ³ com JP e vÃ¡ completando conforme revisa.
            </p>
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn btnAccent" id="btnCreateText"><strong>Criar texto</strong></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Import -->
  <div class="modal" id="modalImport">
    <div class="modalCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Importar dados (JSON)</h2>
        <button class="btn" id="btnCloseModalImport">Fechar</button>
      </div>
      <p class="help">Cole aqui o JSON exportado. Isso vai mesclar biblioteca + progresso + deck.</p>
      <textarea class="textarea" id="importArea" placeholder='{ "texts":[...], "state":{...} }'></textarea>
      <div class="row" style="justify-content:flex-end">
        <button class="btn btnPrimary" id="btnDoImport">Importar agora</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * DATA (N5/N4 samples)
     ***********************/
    const builtInTexts = [
      {
        id: "n5_super",
        level: "N5",
        title: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ã§è²·ã„ç‰©ï¼ˆN5ï¼‰",
        desc: "PartÃ­culas bÃ¡sicasãƒ»ã€œãŸã„ãƒ»contagem simples",
        tags: ["cotidiano", "compras"],
        lines: [
          {
            jp: "ä»Šæ—¥ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ã«è¡Œãã¾ã™ã€‚",
            jpRuby: "ä»Šæ—¥<rt>ãã‚‡ã†</rt>ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ã«è¡Œ<rt>ã„</rt>ãã¾ã™ã€‚",
            reading: "ãã‚‡ã†ã¯ ã™ãƒ¼ã±ãƒ¼ã« ã„ãã¾ã™ã€‚",
            pt: "Hoje eu vou ao supermercado.",
            grammar: "ã« = destino (ir para). ã¯ = tÃ³pico do assunto (hoje).",
            vocab: [
              { w:"ä»Šæ—¥", r:"ãã‚‡ã†", m:"hoje" },
              { w:"è¡Œã", r:"ã„ã", m:"ir" },
              { w:"ã‚¹ãƒ¼ãƒ‘ãƒ¼", r:"ã™ãƒ¼ã±ãƒ¼", m:"supermercado" }
            ]
          },
          {
            jp: "é‡èœã‚’è²·ã„ãŸã„ã§ã™ã€‚",
            jpRuby: "é‡èœ<rt>ã‚„ã•ã„</rt>ã‚’è²·<rt>ã‹</rt>ã„ãŸã„ã§ã™ã€‚",
            reading: "ã‚„ã•ã„ã‚’ ã‹ã„ãŸã„ã§ã™ã€‚",
            pt: "Eu quero comprar legumes/verduras.",
            grammar: "ã€œãŸã„ = desejo (quero fazer). ã‚’ = objeto direto.",
            vocab: [
              { w:"é‡èœ", r:"ã‚„ã•ã„", m:"legumes/verduras" },
              { w:"è²·ã†", r:"ã‹ã†", m:"comprar" }
            ]
          },
          {
            jp: "ã§ã‚‚ã€ãŠé‡‘ãŒã‚ã¾ã‚Šã‚ã‚Šã¾ã›ã‚“ã€‚",
            jpRuby: "ã§ã‚‚ã€ãŠé‡‘<rt>ã‹ã­</rt>ãŒã‚ã¾ã‚Šã‚ã‚Šã¾ã›ã‚“ã€‚",
            reading: "ã§ã‚‚ã€ãŠã‹ã­ãŒ ã‚ã¾ã‚Š ã‚ã‚Šã¾ã›ã‚“ã€‚",
            pt: "Mas eu nÃ£o tenho muito dinheiro.",
            grammar: "ã‚ã¾ã‚Š + negativo = 'nÃ£o muito'. ãŒ = sujeito (o dinheiro).",
            vocab: [
              { w:"ãŠé‡‘", r:"ãŠã‹ã­", m:"dinheiro" },
              { w:"ã‚ã¾ã‚Š", r:"ã‚ã¾ã‚Š", m:"(com negativo) nÃ£o muito" },
              { w:"ã‚ã‚‹", r:"ã‚ã‚‹", m:"haver/ter (inanimado)" }
            ]
          },
          {
            jp: "å®‰ã„ã‚Šã‚“ã”ã‚’ä¸‰ã¤è²·ã„ã¾ã—ãŸã€‚",
            jpRuby: "å®‰<rt>ã‚„ã™</rt>ã„ã‚Šã‚“ã”ã‚’ä¸‰<rt>ã¿ã£</rt>ã¤è²·<rt>ã‹</rt>ã„ã¾ã—ãŸã€‚",
            reading: "ã‚„ã™ã„ ã‚Šã‚“ã”ã‚’ ã¿ã£ã¤ ã‹ã„ã¾ã—ãŸã€‚",
            pt: "Comprei trÃªs maÃ§Ã£s baratas.",
            grammar: "ä¸‰ã¤ = contagem (1ã€œ10 com ã€œã¤). Passado: è²·ã„ã¾ã—ãŸ.",
            vocab: [
              { w:"å®‰ã„", r:"ã‚„ã™ã„", m:"barato" },
              { w:"ä¸‰ã¤", r:"ã¿ã£ã¤", m:"trÃªs (contagem ã€œã¤)" },
              { w:"è²·ã†", r:"ã‹ã†", m:"comprar" }
            ]
          },
          {
            jp: "ãƒ¬ã‚¸ã§ã‚«ãƒ¼ãƒ‰ã§æ‰•ã„ã¾ã™ã€‚",
            jpRuby: "ãƒ¬ã‚¸ã§ã‚«ãƒ¼ãƒ‰ã§æ‰•<rt>ã¯ã‚‰</rt>ã„ã¾ã™ã€‚",
            reading: "ã‚Œã˜ã§ ã‹ãƒ¼ã©ã§ ã¯ã‚‰ã„ã¾ã™ã€‚",
            pt: "No caixa, eu pago com cartÃ£o.",
            grammar: "ã§ = local da aÃ§Ã£o (ãƒ¬ã‚¸ã§) / meio/instrumento (ã‚«ãƒ¼ãƒ‰ã§).",
            vocab: [
              { w:"ãƒ¬ã‚¸", r:"ã‚Œã˜", m:"caixa (checkout)" },
              { w:"æ‰•ã†", r:"ã¯ã‚‰ã†", m:"pagar" },
              { w:"ã‚«ãƒ¼ãƒ‰", r:"ã‹ãƒ¼ã©", m:"cartÃ£o" }
            ]
          },
          {
            jp: "å®¶ã«å¸°ã£ã¦ã€ã™ãæ–™ç†ã—ã¾ã™ã€‚",
            jpRuby: "å®¶<rt>ã„ãˆ</rt>ã«å¸°<rt>ã‹ãˆ</rt>ã£ã¦ã€ã™ãæ–™ç†<rt>ã‚Šã‚‡ã†ã‚Š</rt>ã—ã¾ã™ã€‚",
            reading: "ã„ãˆã« ã‹ãˆã£ã¦ã€ã™ã ã‚Šã‚‡ã†ã‚Šã—ã¾ã™ã€‚",
            pt: "Eu volto para casa e cozinho logo em seguida.",
            grammar: "ã€œã¦ = sequÃªncia de aÃ§Ãµes. ã™ã = imediatamente.",
            vocab: [
              { w:"å®¶", r:"ã„ãˆ", m:"casa" },
              { w:"å¸°ã‚‹", r:"ã‹ãˆã‚‹", m:"voltar" },
              { w:"æ–™ç†", r:"ã‚Šã‚‡ã†ã‚Š", m:"cozinhar / culinÃ¡ria" }
            ]
          }
        ]
      },
      {
        id: "n4_rain",
        level: "N4",
        title: "é›¨ã®æ—¥ã®ç´„æŸï¼ˆN4ï¼‰",
        desc: "ã€œã®ã«ãƒ»ã€œã¦ã—ã¾ã†ãƒ»ã€œãã†ã ãƒ»ç†ç”±/contraste",
        tags: ["clima", "encontro"],
        lines: [
          {
            jp: "æœã‹ã‚‰é›¨ãŒé™ã£ã¦ã„ã¾ã—ãŸã€‚",
            jpRuby: "æœ<rt>ã‚ã•</rt>ã‹ã‚‰é›¨<rt>ã‚ã‚</rt>ãŒé™<rt>ãµ</rt>ã£ã¦ã„ã¾ã—ãŸã€‚",
            reading: "ã‚ã•ã‹ã‚‰ ã‚ã‚ãŒ ãµã£ã¦ã„ã¾ã—ãŸã€‚",
            pt: "Desde a manhÃ£ estava chovendo.",
            grammar: "ã€œã¦ã„ã¾ã—ãŸ = aÃ§Ã£o em progresso/estado no passado.",
            vocab: [
              { w:"æœ", r:"ã‚ã•", m:"manhÃ£" },
              { w:"é›¨", r:"ã‚ã‚", m:"chuva" },
              { w:"é™ã‚‹", r:"ãµã‚‹", m:"cair (chuva/neve)" }
            ]
          },
          {
            jp: "å‹ã ã¡ã¨é§…ã§ä¼šã†ç´„æŸã‚’ã—ã¦ã„ãŸã®ã«ã€é›»è»ŠãŒé…ã‚Œã¾ã—ãŸã€‚",
            jpRuby: "å‹<rt>ã¨ã‚‚</rt>ã ã¡ã¨é§…<rt>ãˆã</rt>ã§ä¼š<rt>ã‚</rt>ã†ç´„æŸ<rt>ã‚„ããã</rt>ã‚’ã—ã¦ã„ãŸã®ã«ã€é›»è»Š<rt>ã§ã‚“ã—ã‚ƒ</rt>ãŒé…<rt>ãŠã</rt>ã‚Œã¾ã—ãŸã€‚",
            reading: "ã¨ã‚‚ã ã¡ã¨ ãˆãã§ ã‚ã† ã‚„ãããã‚’ ã—ã¦ã„ãŸã®ã«ã€ã§ã‚“ã—ã‚ƒãŒ ãŠãã‚Œã¾ã—ãŸã€‚",
            pt: "Eu tinha combinado de encontrar um amigo na estaÃ§Ã£o, mas o trem atrasou.",
            grammar: "ã€œã®ã« = contraste/contrariedade (â€œapesar deâ€¦/masâ€¦â€).",
            vocab: [
              { w:"ç´„æŸ", r:"ã‚„ããã", m:"promessa/combinaÃ§Ã£o" },
              { w:"é›»è»Š", r:"ã§ã‚“ã—ã‚ƒ", m:"trem" },
              { w:"é…ã‚Œã‚‹", r:"ãŠãã‚Œã‚‹", m:"atrasar-se" }
            ]
          },
          {
            jp: "ã‚¹ãƒãƒ›ã§é€£çµ¡ã—ã‚ˆã†ã¨æ€ã£ãŸã‚‰ã€ãƒãƒƒãƒ†ãƒªãƒ¼ãŒåˆ‡ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚",
            jpRuby: "ã‚¹ãƒãƒ›ã§é€£çµ¡<rt>ã‚Œã‚“ã‚‰ã</rt>ã—ã‚ˆã†ã¨æ€<rt>ãŠã‚‚</rt>ã£ãŸã‚‰ã€ãƒãƒƒãƒ†ãƒªãƒ¼ãŒåˆ‡<rt>ã</rt>ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚",
            reading: "ã™ã¾ã»ã§ ã‚Œã‚“ã‚‰ãã—ã‚ˆã†ã¨ ãŠã‚‚ã£ãŸã‚‰ã€ã°ã£ã¦ã‚Šãƒ¼ãŒ ãã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚",
            pt: "Quando pensei em avisar pelo celular, a bateria acabou (infelizmente).",
            grammar: "ã€œã‚ˆã†ã¨æ€ã£ãŸã‚‰ = quando fui tentarâ€¦; ã€œã¦ã—ã¾ã† = conclusÃ£o + nuance de arrependimento/inesperado.",
            vocab: [
              { w:"é€£çµ¡", r:"ã‚Œã‚“ã‚‰ã", m:"contato/avisar" },
              { w:"åˆ‡ã‚Œã‚‹", r:"ãã‚Œã‚‹", m:"acabar (bateria), cortar" },
              { w:"æ€ã†", r:"ãŠã‚‚ã†", m:"pensar/achar" }
            ]
          },
          {
            jp: "ã—ã‹ãŸãŒãªã„ã®ã§ã€è¿‘ãã®ã‚«ãƒ•ã‚§ã§å¾…ã¤ã“ã¨ã«ã—ã¾ã—ãŸã€‚",
            jpRuby: "ã—ã‹ãŸãŒãªã„ã®ã§ã€è¿‘<rt>ã¡ã‹</rt>ãã®ã‚«ãƒ•ã‚§ã§å¾…<rt>ã¾</rt>ã¤ã“ã¨ã«ã—ã¾ã—ãŸã€‚",
            reading: "ã—ã‹ãŸãŒãªã„ã®ã§ã€ã¡ã‹ãã® ã‹ãµã‡ã§ ã¾ã¤ã“ã¨ã«ã—ã¾ã—ãŸã€‚",
            pt: "Como nÃ£o tinha jeito, decidi esperar em um cafÃ© prÃ³ximo.",
            grammar: "V-è¾æ›¸å½¢ + ã“ã¨ã«ã™ã‚‹ = decidir fazer (decisÃ£o).",
            vocab: [
              { w:"ã—ã‹ãŸãŒãªã„", r:"ã—ã‹ãŸãŒãªã„", m:"nÃ£o tem jeito" },
              { w:"è¿‘ã", r:"ã¡ã‹ã", m:"perto / nas proximidades" },
              { w:"å¾…ã¤", r:"ã¾ã¤", m:"esperar" }
            ]
          },
          {
            jp: "çª“ã®å¤–ã‚’è¦‹ã‚‹ã¨ã€é›¨ãŒå¼±ããªã‚Šãã†ã§ã—ãŸã€‚",
            jpRuby: "çª“<rt>ã¾ã©</rt>ã®å¤–<rt>ãã¨</rt>ã‚’è¦‹<rt>ã¿</rt>ã‚‹ã¨ã€é›¨<rt>ã‚ã‚</rt>ãŒå¼±<rt>ã‚ˆã‚</rt>ããªã‚Šãã†ã§ã—ãŸã€‚",
            reading: "ã¾ã©ã® ãã¨ã‚’ ã¿ã‚‹ã¨ã€ã‚ã‚ãŒ ã‚ˆã‚ã ãªã‚Šãã†ã§ã—ãŸã€‚",
            pt: "Ao olhar para fora da janela, parecia que a chuva ia enfraquecer.",
            grammar: "ã€œãã†ã  = parece que vaiâ€¦ (aparÃªncia).",
            vocab: [
              { w:"çª“", r:"ã¾ã©", m:"janela" },
              { w:"å¤–", r:"ãã¨", m:"fora" },
              { w:"å¼±ããªã‚‹", r:"ã‚ˆã‚ããªã‚‹", m:"enfraquecer" }
            ]
          },
          {
            jp: "ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å‹ã ã¡ãŒæ¥ã¦ã€ã€Œã”ã‚ã‚“ã€è¿·ã£ã¦ã—ã¾ã£ãŸã€ã¨è¨€ã„ã¾ã—ãŸã€‚",
            jpRuby: "ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å‹<rt>ã¨ã‚‚</rt>ã ã¡ãŒæ¥<rt>ã</rt>ã¦ã€ã€Œã”ã‚ã‚“ã€è¿·<rt>ã¾ã‚ˆ</rt>ã£ã¦ã—ã¾ã£ãŸã€ã¨è¨€<rt>ã„</rt>ã„ã¾ã—ãŸã€‚",
            reading: "ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ ã¨ã‚‚ã ã¡ãŒ ãã¦ã€ã€Œã”ã‚ã‚“ã€ã¾ã‚ˆã£ã¦ã—ã¾ã£ãŸã€ã¨ã„ã„ã¾ã—ãŸã€‚",
            pt: "Depois de um tempo, meu amigo chegou e disse: â€œDesculpa, eu me perdi.â€",
            grammar: "ã€œã¦ã—ã¾ã£ãŸ = acabou acontecendo (com arrependimento).",
            vocab: [
              { w:"ã—ã°ã‚‰ã", r:"ã—ã°ã‚‰ã", m:"por um tempo" },
              { w:"è¿·ã†", r:"ã¾ã‚ˆã†", m:"perder-se / ficar indeciso" },
              { w:"è¨€ã†", r:"ã„ã†", m:"dizer" }
            ]
          }
        ]
      }
    ];

    /***********************
     * STATE + STORAGE
     ***********************/
    const LS_KEY = "nihongo_textlab_v1";
    const defaultState = {
      texts: [],            // custom texts
      activeTextId: null,
      ui: {
        tab: "TAB_TEXT",
        showFurigana: true,
        showReading: true,
        fontScale: 1
      },
      progress: {
        // [textId]: { doneLines: { [idx]: true }, bookmarked: boolean, notes: string }
      },
      deck: {
        // wordKey: { w,r,m, due:number, ease:number, streak:number, last:number, seen:number }
      }
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return mergeDeep(structuredClone(defaultState), parsed);
      }catch(e){
        console.warn("loadState failed", e);
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      refreshKPIs();
    }

    function mergeDeep(target, source){
      if(typeof source !== "object" || source === null) return target;
      for(const k of Object.keys(source)){
        if(Array.isArray(source[k])) target[k] = source[k];
        else if(typeof source[k] === "object" && source[k] !== null){
          if(typeof target[k] !== "object" || target[k] === null) target[k] = {};
          target[k] = mergeDeep(target[k], source[k]);
        }else{
          target[k] = source[k];
        }
      }
      return target;
    }

    let state = loadState();

    /***********************
     * HELPERS
     ***********************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    function allTexts(){
      // built-ins + custom
      return [...builtInTexts, ...(state.texts || [])];
    }

    function getTextById(id){
      return allTexts().find(t => t.id === id) || null;
    }

    function ensureProgress(textId){
      if(!state.progress[textId]){
        state.progress[textId] = { doneLines:{}, bookmarked:false, notes:"" };
      }
      return state.progress[textId];
    }

    function wordKey(v){ return `${v.w}__${v.r}__${v.m}`; }

    function escapeHTML(s){
      return (s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    /***********************
     * THEME ANIMATION
     ***********************/
    function startTheme(){
      const label = $("#themeLabel");
      let hue = state.ui?.hue ?? 200;
      setInterval(()=>{
        hue = (hue + 9) % 360;
        document.documentElement.style.setProperty("--hue", hue);
        if(state.ui) state.ui.hue = hue;
        if(label) label.textContent = `hsl(${hue})`;
      }, 3500);
      document.documentElement.style.setProperty("--hue", hue);
      if(label) label.textContent = `hsl(${hue})`;
    }

    /***********************
     * RENDER: LIBRARY
     ***********************/
    function renderLibrary(){
      const list = $("#libraryList");
      const level = $("#levelFilter").value;
      const q = $("#searchInput").value.trim().toLowerCase();

      const texts = allTexts()
        .filter(t => level === "ALL" ? true : t.level === level)
        .filter(t => {
          if(!q) return true;
          const hay = `${t.title} ${t.desc} ${(t.tags||[]).join(" ")} ` +
                      (t.lines||[]).map(l=>l.jp).join(" ");
          return hay.toLowerCase().includes(q);
        });

      $("#kpiTexts").textContent = texts.length;

      list.innerHTML = texts.map(t=>{
        const p = ensureProgress(t.id);
        const done = Object.keys(p.doneLines||{}).length;
        const total = (t.lines||[]).length;
        const pct = total ? Math.round((done/total)*100) : 0;

        return `
          <div class="item ${t.id===state.activeTextId ? "active":""}" data-id="${escapeHTML(t.id)}">
            <div class="itemTop">
              <div style="min-width:0">
                <p class="itemTitle">${escapeHTML(t.title)}</p>
                <p class="itemDesc">${escapeHTML(t.desc || "")}</p>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                <span class="tag"><b>${escapeHTML(t.level)}</b></span>
                <span class="tag" title="Linhas revisadas">${done}/${total} â€¢ ${pct}%</span>
                <span class="tag" title="Favorito">${p.bookmarked ? "â˜…" : "â˜†"}</span>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted" style="font-size:12px">Nada encontrado.</div>`;

      $$(".item", list).forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          setActiveText(id);
        });
      });
    }

    /***********************
     * RENDER: MAIN (tabs)
     ***********************/
    function setActiveText(id){
      state.activeTextId = id;
      ensureProgress(id);
      saveState();
      renderLibrary();
      renderMain();
    }

    function setTab(tab){
      state.ui.tab = tab;
      saveState();
      renderMain();
    }

    function renderMain(){
      const text = getTextById(state.activeTextId);
      const empty = $("#emptyState");

      // controls global
      applyFontScale(state.ui.fontScale);
      syncToggleButtons();

      if(!text){
        empty.style.display = "block";
        $("#tab_TEXT").style.display = "none";
        $("#tab_VOCAB").style.display = "none";
        $("#tab_FLASH").style.display = "none";
        $("#tab_QUIZ").style.display = "none";
        $("#tab_NOTES").style.display = "none";
        $("#textTitle").textContent = "Selecione um texto";
        $("#textMeta").innerHTML = "";
        return;
      }

      empty.style.display = "none";

      $("#textTitle").textContent = text.title;
      const p = ensureProgress(text.id);

      $("#textMeta").innerHTML = `
        <span class="tag">ğŸ“˜ <b>${escapeHTML(text.level)}</b></span>
        <span class="tag">ğŸ§¾ ${text.lines.length} linhas</span>
        <span class="tag">âœ… ${Object.keys(p.doneLines||{}).length} revisadas</span>
        <span class="tag">${p.bookmarked ? "â˜… Favorito" : "â˜† NÃ£o favorito"}</span>
        ${(text.tags||[]).slice(0,3).map(t=>`<span class="tag">#${escapeHTML(t)}</span>`).join("")}
      `;

      // tabs show/hide
      const tab = state.ui.tab || "TAB_TEXT";
      const map = {
        TAB_TEXT: "#tab_TEXT",
        TAB_VOCAB: "#tab_VOCAB",
        TAB_FLASH: "#tab_FLASH",
        TAB_QUIZ: "#tab_QUIZ",
        TAB_NOTES: "#tab_NOTES"
      };
      for(const k of Object.keys(map)){
        $(map[k]).style.display = (k === tab) ? "block" : "none";
      }
      $$(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === tab);
      });

      // render each tab content
      renderLines(text, $("#lineList"));
      renderLines(text, $("#focusLineList"), { isFocus:true });

      renderVocab(text);
      renderNotes(text);
      renderDeckUI();
      // quiz not auto-generated
    }

    function renderLines(text, root, opts={}){
      const p = ensureProgress(text.id);
      const showF = !!state.ui.showFurigana;
      const showR = !!state.ui.showReading;

      root.innerHTML = text.lines.map((ln, idx)=>{
        const done = !!p.doneLines?.[idx];
        const jp = showF && ln.jpRuby ? ln.jpRuby : escapeHTML(ln.jp);
        const reading = showR ? `<div class="reading">${escapeHTML(ln.reading||"")}</div>` : "";

        const vocabChips = (ln.vocab||[]).slice(0,8).map(v=>`<span class="tag" title="${escapeHTML(v.r)} â€¢ ${escapeHTML(v.m)}">${escapeHTML(v.w)}</span>`).join("");

        const noteKey = `lineNote_${text.id}_${idx}`;
        const lineNote = (state.progress[text.id]?.[noteKey]) || "";

        return `
          <div class="lineCard" data-idx="${idx}">
            <div class="lineTop">
              <div class="lineLeft">
                <p class="jp">${jp}</p>
                ${reading}
                <div class="row" style="margin-top:8px">${vocabChips || `<span class="muted" style="font-size:12px">Sem vocab marcado nesta linha.</span>`}</div>
              </div>
              <div class="lineBadges">
                <label class="chk" title="Marque quando revisar esta linha">
                  <input type="checkbox" ${done ? "checked":""} />
                  Revisada
                </label>
                <button class="btn" data-action="toggle">Detalhes</button>
              </div>
            </div>

            <div class="details">
              <div class="notes">
                <div class="box">
                  <div class="boxTitle"><b>TraduÃ§Ã£o (PT)</b></div>
                  <p class="pt">${escapeHTML(ln.pt || "â€”")}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>GramÃ¡tica / Pontos de atenÃ§Ã£o</b></div>
                  <p>${escapeHTML(ln.grammar || "â€”")}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>VocabulÃ¡rio (linha)</b></div>
                  <p>
                    ${(ln.vocab||[]).map(v=>`<span class="tag" style="margin:4px 6px 0 0">ğŸ§© <b>${escapeHTML(v.w)}</b> ${escapeHTML(v.r)} â€¢ ${escapeHTML(v.m)}</span>`).join("") || "â€”"}
                  </p>
                  <div class="row" style="margin-top:10px">
                    <button class="btn" data-action="addLineVocab">+ Deck (toda a linha)</button>
                    <button class="btn" data-action="copyJP">Copiar JP</button>
                  </div>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Minha nota desta linha</b></div>
                  <textarea class="textarea" data-action="lineNote" placeholder="Escreva aqui (auto-save)..." style="min-height:84px">${escapeHTML(lineNote)}</textarea>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // bind
      $$(".lineCard", root).forEach(card=>{
        const idx = Number(card.getAttribute("data-idx"));
        const chk = $("input[type=checkbox]", card);
        const btnToggle = $("[data-action=toggle]", card);

        chk.addEventListener("change", ()=>{
          const pr = ensureProgress(text.id);
          if(chk.checked) pr.doneLines[idx] = true;
          else delete pr.doneLines[idx];
          saveState();
          refreshKPIs();
          // update meta
          $("#textMeta").innerHTML = $("#textMeta").innerHTML; // noop-ish
          renderLibrary();
          // (nÃ£o re-render tudo pra evitar perder abertura)
        });

        btnToggle.addEventListener("click", ()=>{
          card.classList.toggle("open");
        });

        // clicking JP area toggles too (nice UX)
        $(".jp", card).addEventListener("click", ()=> card.classList.toggle("open"));

        // line note autosave
        const noteArea = $("[data-action=lineNote]", card);
        noteArea.addEventListener("input", ()=>{
          const key = `lineNote_${text.id}_${idx}`;
          state.progress[text.id][key] = noteArea.value;
          saveState();
        });

        // actions
        const btnAdd = $("[data-action=addLineVocab]", card);
        btnAdd.addEventListener("click", ()=>{
          const ln = text.lines[idx];
          addVocabToDeck(ln.vocab||[]);
          renderDeckUI();
          refreshKPIs();
        });

        const btnCopy = $("[data-action=copyJP]", card);
        btnCopy.addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText(text.lines[idx].jp);
            toast("JP copiado âœ…");
          }catch{
            toast("NÃ£o foi possÃ­vel copiar (permissÃ£o).");
          }
        });
      });
    }

    function renderVocab(text){
      const grid = $("#vocabGrid");
      const vocab = aggregateVocab(text);

      if(!vocab.length){
        grid.innerHTML = `<div class="muted" style="font-size:12px">Sem vocabulÃ¡rio neste texto.</div>`;
        return;
      }

      grid.innerHTML = vocab.map(v=>{
        const k = wordKey(v);
        const inDeck = !!state.deck[k];
        return `
          <div class="vocabCard">
            <div>
              <p class="w">${escapeHTML(v.w)}</p>
              <div class="r">${escapeHTML(v.r)}</div>
              <div class="m">${escapeHTML(v.m)}</div>
              <div style="margin-top:8px">
                <span class="tag" title="OcorrÃªncias no texto">ğŸ“ ${v.count}x</span>
              </div>
            </div>
            <div class="vocabRight">
              <button class="btn ${inDeck ? "" : "btnPrimary"}" data-add="${escapeHTML(k)}">
                ${inDeck ? "No deck âœ“" : "+ Deck"}
              </button>
              <button class="btn" data-remove="${escapeHTML(k)}">Remover</button>
            </div>
          </div>
        `;
      }).join("");

      $$("[data-add]", grid).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const k = btn.getAttribute("data-add");
          const v = vocab.find(x=>wordKey(x)===k);
          if(v) addVocabToDeck([v]);
          renderVocab(text);
          renderDeckUI();
          refreshKPIs();
          toast("Adicionado ao deck âœ…");
        });
      });

      $$("[data-remove]", grid).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const k = btn.getAttribute("data-remove");
          if(state.deck[k]) delete state.deck[k];
          saveState();
          renderVocab(text);
          renderDeckUI();
          refreshKPIs();
          toast("Removido do deck.");
        });
      });
    }

    function renderNotes(text){
      const area = $("#textNotes");
      const p = ensureProgress(text.id);
      area.value = p.notes || "";
      area.oninput = ()=>{
        p.notes = area.value;
        saveState();
      };
    }

    /***********************
     * VOCAB AGGREGATION + DECK
     ***********************/
    function aggregateVocab(text){
      const map = new Map();
      for(const ln of (text.lines||[])){
        for(const v of (ln.vocab||[])){
          const k = wordKey(v);
          if(!map.has(k)) map.set(k, { ...v, count: 0 });
          map.get(k).count += 1;
        }
      }
      return Array.from(map.values()).sort((a,b)=>b.count-a.count || a.w.localeCompare(b.w));
    }

    function addVocabToDeck(arr){
      const now = Date.now();
      for(const v of arr){
        const k = wordKey(v);
        if(!state.deck[k]){
          state.deck[k] = {
            w: v.w, r: v.r, m: v.m,
            due: now, ease: 2.2, streak: 0, last: 0, seen: 0
          };
        }
      }
      saveState();
    }

    function deckDueList(){
      const now = Date.now();
      return Object.values(state.deck)
        .filter(c => (c.due ?? 0) <= now)
        .sort((a,b)=>(a.due??0)-(b.due??0));
    }

    let currentCardKey = null;

    function pickNextCard(){
      const due = deckDueList();
      if(due.length){
        currentCardKey = wordKey(due[0]);
        return state.deck[currentCardKey];
      }
      // if none due, pick soonest
      const all = Object.values(state.deck);
      if(!all.length){ currentCardKey = null; return null; }
      all.sort((a,b)=>(a.due??0)-(b.due??0));
      currentCardKey = wordKey(all[0]);
      return state.deck[currentCardKey];
    }

    function renderDeckUI(){
      const card = pickNextCard();
      const flash = $("#flashCard");
      const front = $("#flashFront");
      const reading = $("#flashReading");
      const meaning = $("#flashMeaning");
      const status = $("#deckStatus");

      flash.classList.remove("revealed");

      const total = Object.keys(state.deck).length;
      const dueCount = deckDueList().length;

      $("#kpiDeck").textContent = total;

      if(!card){
        front.textContent = "â€”";
        reading.textContent = "";
        meaning.textContent = "Adicione palavras ao deck na aba VocabulÃ¡rio.";
        status.textContent = `Deck vazio.`;
        return;
      }

      front.textContent = card.w;
      reading.textContent = card.r || "";
      meaning.textContent = card.m || "";
      status.textContent = `Cards: ${total} â€¢ Devidos agora: ${dueCount} â€¢ PrÃ³ximo: ${new Date(card.due).toLocaleString()}`;
    }

    function rateCard(score){
      // score 1..3
      if(!currentCardKey || !state.deck[currentCardKey]) return;
      const c = state.deck[currentCardKey];
      const now = Date.now();
      c.seen = (c.seen||0) + 1;
      c.last = now;

      // Very lightweight scheduling:
      // score 1: reset streak, due soon
      // score 2: modest interval
      // score 3: expand interval more
      const base = 60 * 60 * 1000; // 1h
      let interval;
      if(score === 1){
        c.streak = 0;
        c.ease = clamp((c.ease||2.2) - 0.15, 1.3, 3.0);
        interval = base * 3; // 3h
      }else if(score === 2){
        c.streak = (c.streak||0) + 1;
        c.ease = clamp((c.ease||2.2) + 0.05, 1.3, 3.0);
        interval = base * 12 * (c.ease||2.2) * Math.max(1, c.streak/2);
      }else{
        c.streak = (c.streak||0) + 1;
        c.ease = clamp((c.ease||2.2) + 0.12, 1.3, 3.0);
        interval = base * 36 * (c.ease||2.2) * Math.max(1, c.streak/1.5);
      }
      c.due = now + interval;

      saveState();
      renderDeckUI();
    }

    /***********************
     * QUIZ
     ***********************/
    function buildQuizItems(source, count){
      let pool = [];
      if(source === "DECK"){
        pool = Object.values(state.deck).map(x=>({ w:x.w, r:x.r, m:x.m }));
      }else{
        const text = getTextById(state.activeTextId);
        if(text) pool = aggregateVocab(text).map(x=>({ w:x.w, r:x.r, m:x.m }));
      }
      pool = pool.filter(x=>x.w && x.m);
      // unique by wordKey
      const uniq = new Map();
      for(const v of pool) uniq.set(wordKey(v), v);
      const arr = Array.from(uniq.values());
      shuffle(arr);
      return arr.slice(0, count);
    }

    function renderQuiz(){
      const wrap = $("#quizWrap");
      wrap.innerHTML = "";

      const src = $("#quizSource").value;
      const count = Number($("#quizCount").value);
      const items = buildQuizItems(src, count);

      if(items.length < 3){
        wrap.innerHTML = `<div class="muted" style="font-size:12px;margin-top:12px">NÃ£o hÃ¡ vocabulÃ¡rio suficiente para montar um quiz (mÃ­nimo ~3). Adicione mais palavras ao deck ou use um texto com mais vocab.</div>`;
        return;
      }

      const allMeanings = items.map(x=>x.m);

      items.forEach((it, idx)=>{
        const correct = it.m;
        const wrong = shuffle(allMeanings.filter(m=>m!==correct)).slice(0,3);
        const choices = shuffle([correct, ...wrong]);

        const el = document.createElement("div");
        el.className = "quizQ";
        el.innerHTML = `
          <h3>Q${idx+1}. O que significa <span style="font-family:var(--jp);font-weight:900">${escapeHTML(it.w)}</span> (${escapeHTML(it.r||"")})?</h3>
          <div class="choices">
            ${choices.map(c=>`
              <div class="choice" data-c="${escapeHTML(c)}" data-correct="${escapeHTML(correct)}">
                <div>${escapeHTML(c)}</div>
                <small>clique</small>
              </div>
            `).join("")}
          </div>
        `;
        wrap.appendChild(el);

        $$(".choice", el).forEach(ch=>{
          ch.addEventListener("click", ()=>{
            const picked = ch.getAttribute("data-c");
            const corr = ch.getAttribute("data-correct");
            // lock
            $$(".choice", el).forEach(x=>x.style.pointerEvents="none");
            $$(".choice", el).forEach(x=>{
              const val = x.getAttribute("data-c");
              if(val === corr) x.classList.add("good");
              else if(val === picked) x.classList.add("bad");
            });
          });
        });
      });
    }

    function shuffle(a){
      const arr = a.slice();
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /***********************
     * UI TOGGLES / FONT
     ***********************/
    function applyFontScale(scale){
      state.ui.fontScale = clamp(scale, 0.85, 1.25);
      document.documentElement.style.setProperty("--fontScale", state.ui.fontScale);
      saveState();
    }

    function syncToggleButtons(){
      const f = state.ui.showFurigana ? "ON" : "OFF";
      const r = state.ui.showReading ? "ON" : "OFF";
      ["#btnToggleFuri","#btnToggleFuri2","#btnToggleFuriFocus"].forEach(id=>{
        const b = $(id); if(b) b.textContent = `Furigana: ${f}`;
      });
      ["#btnToggleReading","#btnToggleReading2","#btnToggleReadingFocus"].forEach(id=>{
        const b = $(id); if(b) b.textContent = `Leitura: ${r}`;
      });
    }

    function toggleFurigana(){
      state.ui.showFurigana = !state.ui.showFurigana;
      saveState();
      syncToggleButtons();
      renderMain();
    }

    function toggleReading(){
      state.ui.showReading = !state.ui.showReading;
      saveState();
      syncToggleButtons();
      renderMain();
    }

    function fontPlus(){ applyFontScale((state.ui.fontScale||1) + 0.05); renderMain(); }
    function fontMinus(){ applyFontScale((state.ui.fontScale||1) - 0.05); renderMain(); }

    /***********************
     * BOOKMARK / BULK OPEN
     ***********************/
    function toggleBookmark(){
      const text = getTextById(state.activeTextId);
      if(!text) return;
      const p = ensureProgress(text.id);
      p.bookmarked = !p.bookmarked;
      saveState();
      renderLibrary();
      renderMain();
      toast(p.bookmarked ? "Favoritado â˜…" : "Desfavoritado â˜†");
    }

    function expandAll(){
      $$(".lineCard", $("#lineList")).forEach(c=>c.classList.add("open"));
      $$(".lineCard", $("#focusLineList")).forEach(c=>c.classList.add("open"));
    }
    function collapseAll(){
      $$(".lineCard", $("#lineList")).forEach(c=>c.classList.remove("open"));
      $$(".lineCard", $("#focusLineList")).forEach(c=>c.classList.remove("open"));
    }

    /***********************
     * MODALS + CUSTOM TEXT
     ***********************/
    function openModal(id){ $(id).classList.add("open"); }
    function closeModal(id){ $(id).classList.remove("open"); }

    function makeId(prefix){
      return prefix + "_" + Math.random().toString(36).slice(2,8) + "_" + Date.now().toString(36);
    }

    function createCustomText(){
      const title = $("#newTitle").value.trim();
      const level = $("#newLevel").value;
      const desc  = $("#newDesc").value.trim();
      const raw   = $("#newRaw").value.replace(/\r/g,"").trim();

      if(!title || !raw){
        toast("Preencha pelo menos TÃ­tulo e Texto.");
        return;
      }

      const lines = raw.split("\n")
        .map(s=>s.trim())
        .filter(Boolean)
        .map(s=>({
          jp: s,
          jpRuby: "", // vocÃª pode preencher depois, se quiser
          reading: "",
          pt: "",
          grammar: "",
          vocab: []
        }));

      const text = {
        id: makeId("custom"),
        level,
        title,
        desc,
        tags: ["custom"],
        lines
      };

      state.texts.push(text);
      saveState();
      closeModal("#modalNew");
      // clear
      $("#newTitle").value = "";
      $("#newDesc").value = "";
      $("#newRaw").value = "";
      setActiveText(text.id);
      toast("Texto criado âœ…");
    }

    /***********************
     * EXPORT / IMPORT
     ***********************/
    function exportAll(){
      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        texts: state.texts,
        state: {
          activeTextId: state.activeTextId,
          ui: state.ui,
          progress: state.progress,
          deck: state.deck
        }
      };
      const json = JSON.stringify(payload, null, 2);
      // download via blob
      const blob = new Blob([json], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "nihongo_textlab_export.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exportado âœ…");
    }

    function doImport(){
      const raw = $("#importArea").value.trim();
      if(!raw){ toast("Cole um JSON vÃ¡lido."); return; }
      try{
        const parsed = JSON.parse(raw);
        // merge: texts concat by id unique
        const incomingTexts = parsed.texts || [];
        const existing = new Map((state.texts||[]).map(t=>[t.id,t]));
        for(const t of incomingTexts){
          if(!t?.id) continue;
          if(!existing.has(t.id)) existing.set(t.id, t);
          else existing.set(t.id, mergeDeep(existing.get(t.id), t));
        }
        state.texts = Array.from(existing.values());

        // merge state buckets
        const incState = parsed.state || {};
        state.ui = mergeDeep(state.ui, incState.ui || {});
        state.progress = mergeDeep(state.progress, incState.progress || {});
        state.deck = mergeDeep(state.deck, incState.deck || {});
        if(incState.activeTextId) state.activeTextId = incState.activeTextId;

        saveState();
        closeModal("#modalImport");
        renderLibrary();
        renderMain();
        toast("Importado âœ…");
      }catch(e){
        toast("JSON invÃ¡lido.");
      }
    }

    function resetPartial(){
      // keep texts, wipe progress + ui minimal + deck optional? We'll wipe progress only.
      if(!confirm("Resetar progresso (linhas revisadas, favoritos e notas)? O deck e os textos serÃ£o mantidos.")) return;
      state.progress = {};
      saveState();
      renderLibrary();
      renderMain();
      toast("Progresso resetado.");
    }

    /***********************
     * KPI
     ***********************/
    function refreshKPIs(){
      // lines done total across all texts (built-ins + custom)
      let doneTotal = 0;
      for(const tid of Object.keys(state.progress||{})){
        const p = state.progress[tid];
        doneTotal += Object.keys(p.doneLines||{}).length;
      }
      $("#kpiLinesDone").textContent = doneTotal;
      $("#kpiDeck").textContent = Object.keys(state.deck||{}).length;
    }

    /***********************
     * TOAST
     ***********************/
    let toastTimer = null;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = $("#toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "999px";
        el.style.border = "1px solid rgba(255,255,255,.18)";
        el.style.background = "rgba(0,0,0,.45)";
        el.style.backdropFilter = "blur(10px)";
        el.style.webkitBackdropFilter = "blur(10px)";
        el.style.boxShadow = "0 18px 55px rgba(0,0,0,.40)";
        el.style.color = "rgba(234,240,255,.92)";
        el.style.fontSize = "12px";
        el.style.fontWeight = "800";
        el.style.zIndex = "80";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1600);
    }

    /***********************
     * EVENTS
     ***********************/
    function bindEvents(){
      // tabs
      $$(".tab").forEach(t=>{
        t.addEventListener("click", ()=> setTab(t.dataset.tab));
      });

      // library controls
      $("#levelFilter").addEventListener("change", renderLibrary);
      $("#searchInput").addEventListener("input", renderLibrary);

      // global toggles (home)
      $("#btnToggleFuri").addEventListener("click", toggleFurigana);
      $("#btnToggleFuri2").addEventListener("click", toggleFurigana);
      $("#btnToggleFuriFocus").addEventListener("click", toggleFurigana);

      $("#btnToggleReading").addEventListener("click", toggleReading);
      $("#btnToggleReading2").addEventListener("click", toggleReading);
      $("#btnToggleReadingFocus").addEventListener("click", toggleReading);

      $("#btnFontPlus").addEventListener("click", fontPlus);
      $("#btnFontPlus2").addEventListener("click", fontPlus);
      $("#btnFontPlusFocus").addEventListener("click", fontPlus);

      $("#btnFontMinus").addEventListener("click", fontMinus);
      $("#btnFontMinus2").addEventListener("click", fontMinus);
      $("#btnFontMinusFocus").addEventListener("click", fontMinus);

      $("#btnBookmark").addEventListener("click", toggleBookmark);

      $("#btnExpandAll").addEventListener("click", expandAll);
      $("#btnCollapseAll").addEventListener("click", collapseAll);

      // focus
      $("#btnFocus").addEventListener("click", ()=>{
        $("#focusOverlay").classList.add("open");
      });
      $("#btnExitFocus").addEventListener("click", ()=>{
        $("#focusOverlay").classList.remove("open");
      });

      // deck
      $("#btnReveal").addEventListener("click", ()=>{
        $("#flashCard").classList.toggle("revealed");
      });
      $("#btnNext").addEventListener("click", ()=>{
        renderDeckUI();
      });
      $("#btnRate1").addEventListener("click", ()=> rateCard(1));
      $("#btnRate2").addEventListener("click", ()=> rateCard(2));
      $("#btnRate3").addEventListener("click", ()=> rateCard(3));
      $("#btnClearDeck").addEventListener("click", ()=>{
        if(!confirm("Limpar todo o deck?")) return;
        state.deck = {};
        saveState();
        renderDeckUI();
        refreshKPIs();
      });

      // quiz
      $("#btnNewQuiz").addEventListener("click", renderQuiz);

      // notes
      $("#btnClearNotes").addEventListener("click", ()=>{
        const text = getTextById(state.activeTextId);
        if(!text) return;
        if(!confirm("Limpar as notas deste texto?")) return;
        ensureProgress(text.id).notes = "";
        saveState();
        renderNotes(text);
        toast("Notas limpas.");
      });

      // modals
      $("#btnNewText").addEventListener("click", ()=> openModal("#modalNew"));
      $("#btnCloseModalNew").addEventListener("click", ()=> closeModal("#modalNew"));
      $("#btnCreateText").addEventListener("click", createCustomText);

      $("#btnExport").addEventListener("click", exportAll);
      $("#btnImport").addEventListener("click", ()=> openModal("#modalImport"));
      $("#btnCloseModalImport").addEventListener("click", ()=> closeModal("#modalImport"));
      $("#btnDoImport").addEventListener("click", doImport);

      $("#btnReset").addEventListener("click", resetPartial);

      // close modal by clicking outside
      ["#modalNew", "#modalImport"].forEach(mid=>{
        $(mid).addEventListener("click", (e)=>{
          if(e.target === $(mid)) closeModal(mid);
        });
      });

      // keyboard shortcuts
      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          $("#modalNew").classList.remove("open");
          $("#modalImport").classList.remove("open");
          $("#focusOverlay").classList.remove("open");
        }
      });
    }

    /***********************
     * INIT
     ***********************/
    function init(){
      // defaults if missing
      state.texts = state.texts || [];
      state.progress = state.progress || {};
      state.deck = state.deck || {};
      state.ui = mergeDeep({ tab:"TAB_TEXT", showFurigana:true, showReading:true, fontScale:1, hue:200 }, state.ui || {});
      applyFontScale(state.ui.fontScale || 1);

      startTheme();
      bindEvents();

      // pick first text if none selected
      if(!state.activeTextId){
        state.activeTextId = builtInTexts[0].id;
      }
      ensureProgress(state.activeTextId);

      renderLibrary();
      renderMain();
      refreshKPIs();
    }

    init();
  </script>
</body>
</html>
