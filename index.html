<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ヴァンパイア全知全能 — Kanji & Jogo</title>

<style>
  :root{
    --bg:#0b0f14;
    --border:rgba(255,255,255,.16);
    --text:#eef2ff;
    --muted:rgba(238,242,255,.72);
    --muted2:rgba(238,242,255,.55);

    /* THEME (muda a cada 5s) */
    --themeHue: 195;
    --accent:  hsl(calc(var(--themeHue) - 25) 90% 60%);
    --accent2: hsl(var(--themeHue) 90% 58%);
    --accent3: hsl(calc(var(--themeHue) + 55) 90% 60%);
    --glow: 0 0 30px rgba(0,0,0,.55);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 700px at 18% 15%, color-mix(in oklab, var(--accent2) 18%, transparent) 0%, transparent 65%),
      radial-gradient(900px 650px at 78% 18%, color-mix(in oklab, var(--accent3) 14%, transparent) 0%, transparent 70%),
      radial-gradient(900px 650px at 55% 92%, color-mix(in oklab, var(--accent) 12%, transparent) 0%, transparent 70%),
      linear-gradient(180deg, #070a0f 0%, #0b0f14 40%, #070a0f 100%);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
    overflow-x:hidden;
  }

  /* Kanji Rain canvas */
  #rain{
    position:fixed;
    inset:0;
    z-index:0;
    opacity:.6;
    pointer-events:none;
  }

  /* ====== AQUI: PERGUNTA CENTRALIZADA UM POUCO ACIMA ====== */
  .philo-question{
    position:fixed;
    left:50%;
    top:14vh;                /* “um pouco acima” */
    transform:translateX(-50%);
    z-index:50;
    pointer-events:none;     /* não atrapalha cliques */
    padding:10px 14px;
    border-radius:16px;
    border:1px solid color-mix(in oklab, var(--accent2) 40%, rgba(255,255,255,.12));
    background: rgba(10,14,20,.48);
    backdrop-filter: blur(10px);
    box-shadow: 0 18px 50px rgba(0,0,0,.45);
    max-width:min(880px, calc(100vw - 28px));
    display:flex;
    align-items:center;
    gap:10px;
  }
  .philo-dot{
    width:10px;height:10px;border-radius:999px;
    background: var(--accent2);
    box-shadow: 0 0 18px color-mix(in oklab, var(--accent2) 55%, transparent);
    flex:0 0 auto;
  }
  .philo-text{
    font-weight:800;
    letter-spacing:.02em;
    font-size: clamp(14px, 1.7vw, 18px);
    color: color-mix(in oklab, var(--text) 86%, var(--accent2));
    text-shadow: 0 0 18px rgba(0,0,0,.35);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .philo-sub{
    margin-left:auto;
    font-size:12px;
    color: var(--muted2);
    display:none;
  }
  @media (min-width:860px){
    .philo-sub{display:block}
  }

  /* Layout */
  .wrap{
    position:relative;
    z-index:1;
    width:min(1200px, calc(100% - 28px));
    margin:0 auto;
    padding:22px 0 40px;
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:14px;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    background:rgba(10,14,20,.35);
    backdrop-filter: blur(10px);
    box-shadow: var(--glow);
  }

  .brand{
    display:flex; align-items:center; gap:12px;
    min-width:0;
  }
  .brand h1{
    margin:0;
    font-size:clamp(16px, 2.2vw, 22px);
    letter-spacing:.03em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .badge{
    font-size:12px;
    color:var(--muted);
    padding:5px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
  }

  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  button{
    appearance:none;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(10,14,20,.35);
    color: var(--text);
    padding:10px 12px;
    border-radius:14px;
    cursor:pointer;
    font-weight:700;
    letter-spacing:.01em;
    transition: transform .12s ease, border-color .18s ease, background .18s ease;
    backdrop-filter: blur(10px);
  }
  button:hover{
    transform: translateY(-1px);
    border-color: color-mix(in oklab, var(--accent2) 55%, rgba(255,255,255,.18));
    background: rgba(10,14,20,.50);
  }
  button.primary{
    background: linear-gradient(135deg, color-mix(in oklab, var(--accent2) 65%, #0b0f14), rgba(10,14,20,.35));
    border-color: color-mix(in oklab, var(--accent2) 55%, rgba(255,255,255,.18));
  }

  /* Hero */
  .hero{
    margin-top:16px;
    border-radius:24px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.32);
    backdrop-filter: blur(12px);
    box-shadow: var(--glow);
    overflow:hidden;
    position:relative;
  }

  .heroGrid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:18px;
    padding:18px;
    align-items:stretch;
  }
  @media (max-width: 980px){
    .heroGrid{grid-template-columns:1fr}
  }

  .heroLeft{
    position:relative;
    padding:16px;
    border-radius:20px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    overflow:hidden;
  }
  .heroLeft .mujo{
    position:absolute;
    right:18px;
    bottom:8px;
    font-size: clamp(56px, 10vw, 120px);
    font-weight:900;
    letter-spacing:.02em;
    color: color-mix(in oklab, var(--text) 12%, transparent);
    text-shadow: 0 0 40px rgba(0,0,0,.5);
    user-select:none;
    pointer-events:none;
  }
  .heroLeft p{
    margin:0 0 12px 0;
    color:var(--muted);
    line-height:1.55;
  }
  .hint{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .pill{
    font-size:12px;
    color:var(--muted);
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.30);
  }

  .heroRight{
    border-radius:20px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    padding:16px;
    position:relative;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .toriiWrap{
    display:flex;
    justify-content:center;
    align-items:center;
    padding:10px 0;
  }
  .torii{
    width:min(360px, 100%);
    filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
  }
  .cdz{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.30);
  }
  .cdzTitle{
    font-weight:900;
    letter-spacing:.02em;
  }
  .cdzSmall{
    font-size:12px;
    color:var(--muted2);
    line-height:1.35;
  }
  .spark{
    width:44px;height:44px;border-radius:16px;
    background: radial-gradient(circle at 30% 35%, rgba(255,255,255,.18), transparent 55%),
      radial-gradient(circle at 70% 65%, color-mix(in oklab, var(--accent2) 55%, transparent), transparent 60%),
      linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,.15));
    border:1px solid rgba(255,255,255,.14);
  }

  /* Main sections */
  .grid{
    margin-top:16px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
  .card{
    border-radius:22px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.30);
    backdrop-filter: blur(12px);
    box-shadow: var(--glow);
    overflow:hidden;
  }
  .cardHeader{
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
  }
  .cardHeader h2{
    margin:0;
    font-size:16px;
    letter-spacing:.02em;
  }
  .cardHeader .meta{
    font-size:12px;
    color:var(--muted2);
  }
  .cardBody{padding:16px}

  /* Game */
  .bigKanji{
    font-size:74px;
    font-weight:900;
    letter-spacing:.03em;
    margin:0;
    text-align:center;
    text-shadow: 0 0 30px rgba(0,0,0,.55);
  }
  .prompt{
    margin:10px 0 0;
    color:var(--muted);
    text-align:center;
    line-height:1.5;
  }
  .choices{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:14px;
  }
  @media (max-width:520px){
    .choices{grid-template-columns:1fr}
  }
  .choice{
    text-align:left;
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    cursor:pointer;
    transition: transform .12s ease, border-color .18s ease, background .18s ease;
  }
  .choice:hover{
    transform: translateY(-1px);
    border-color: color-mix(in oklab, var(--accent2) 55%, rgba(255,255,255,.18));
    background: rgba(0,0,0,.22);
  }
  .choice .jp{font-weight:900}
  .choice .pt{font-size:12px;color:var(--muted2);margin-top:4px;line-height:1.35}
  .statusRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-top:14px;
  }
  .statusRow .stat{
    font-size:12px;
    color:var(--muted);
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.25);
  }
  .toast{
    margin-top:12px;
    border-radius:16px;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.25);
    color:var(--muted);
    display:none;
  }
  .toast.show{display:block}
  .toast.good{border-color: color-mix(in oklab, var(--accent2) 60%, rgba(255,255,255,.12))}
  .toast.bad{border-color: rgba(255,80,80,.55)}

  /* Vocab */
  .tabs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .tabs button{
    padding:9px 10px;
    border-radius:999px;
    font-size:12px;
  }
  .vlist{
    display:grid;
    gap:10px;
  }
  .vitem{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    padding:12px;
  }
  .vtop{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
  }
  .vkanji{
    font-weight:900;
    font-size:22px;
    letter-spacing:.02em;
  }
  .vreading{
    color:var(--muted);
    font-size:12px;
  }
  .vmeaning{
    margin-top:8px;
    color:var(--muted);
    line-height:1.55;
  }
  .vocabs{
    margin-top:10px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .vchip{
    font-size:12px;
    padding:6px 9px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(10,14,20,.25);
    color:var(--muted);
  }

  /* Review overlay */
  .overlay{
    position:fixed;
    inset:0;
    z-index:80;
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    background: rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
  }
  .overlay.show{display:flex}
  .modal{
    width:min(920px, 100%);
    border-radius:24px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(10,14,20,.55);
    box-shadow: 0 40px 120px rgba(0,0,0,.7);
    overflow:hidden;
  }
  .modalHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.12);
  }
  .modalHead .title{
    font-weight:900;
    letter-spacing:.02em;
  }
  .modalBody{
    padding:16px;
    max-height: min(68vh, 520px);
    overflow:auto;
  }
  .reviewGrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  @media (max-width: 720px){
    .reviewGrid{grid-template-columns:1fr}
  }
  .reviewCard{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.16);
    padding:12px;
  }
  .reviewCard .k{font-weight:900;font-size:20px}
  .reviewCard .r{font-size:12px;color:var(--muted);margin-top:2px}
  .reviewCard .m{color:var(--muted);margin-top:8px;line-height:1.5}

  .foot{
    margin-top:16px;
    color:var(--muted2);
    font-size:12px;
    text-align:center;
    padding:10px;
  }
</style>
</head>

<body>
<canvas id="rain"></canvas>

<!-- PERGUNTA CENTRALIZADA UM POUCO ACIMA (não atrapalha nada) -->
<div class="philo-question" aria-hidden="true">
  <span class="philo-dot"></span>
  <span class="philo-text">どんな哲学者や哲学が好きですか？</span>
  <span class="philo-sub">（P = Revisar / Space = Próximo）</span>
</div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="badge">無常</div>
      <h1>ヴァンパイア全知全能 — Kanji & Jogo</h1>
    </div>
    <div class="actions">
      <button class="primary" id="btnNext">Próximo</button>
      <button id="btnReveal">Revelar</button>
      <button id="btnReview">Revisar (P)</button>
      <button id="btnReset">Reset</button>
    </div>
  </div>

  <section class="hero">
    <div class="heroGrid">
      <div class="heroLeft">
        <div class="mujo">無常</div>
        <p style="margin-top:0">
          Treino de Kanji (N5/N4) com vibe “noite + néon”. Teclado: <b>Space</b> = próximo / <b>Enter</b> = revelar / <b>P</b> = revisar.
        </p>
        <p>
          O tema muda de cor automaticamente a cada 5s. A “chuva de kanji” fica visível desde o início, mas moderada.
        </p>
        <div class="hint">
          <span class="pill">Gestão de risco: foco no básico (N5) → depois N4</span>
          <span class="pill">Consistência &gt; intensidade</span>
          <span class="pill">Acerto ≠ sorte (processo)</span>
        </div>
      </div>

      <div class="heroRight">
        <div class="toriiWrap" aria-hidden="true">
          <!-- Torii vermelho com detalhes (SVG) -->
          <svg class="torii" viewBox="0 0 860 360" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Torii">
            <defs>
              <linearGradient id="gRed" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#ff2a2a"/>
                <stop offset="0.55" stop-color="#d41414"/>
                <stop offset="1" stop-color="#8b0b0b"/>
              </linearGradient>
              <linearGradient id="gShade" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,.22)"/>
                <stop offset="1" stop-color="rgba(0,0,0,.25)"/>
              </linearGradient>
            </defs>

            <!-- top kasagi -->
            <path d="M90 66 C170 28, 690 28, 770 66 L810 84 C690 26, 170 26, 50 84 Z" fill="url(#gRed)" stroke="rgba(255,255,255,.15)" stroke-width="6"/>
            <!-- shimaki -->
            <path d="M140 112 C210 92, 650 92, 720 112 L705 138 C640 122, 220 122, 155 138 Z" fill="url(#gRed)" stroke="rgba(255,255,255,.12)" stroke-width="5"/>

            <!-- gakuzuka (central plaque) -->
            <g>
              <rect x="386" y="132" width="88" height="78" rx="12" fill="#210606" stroke="rgba(255,255,255,.18)" stroke-width="4"/>
              <rect x="404" y="148" width="52" height="46" rx="10" fill="url(#gRed)" stroke="rgba(255,255,255,.14)" stroke-width="3"/>
              <path d="M420 171 h24" stroke="rgba(255,255,255,.55)" stroke-width="5" stroke-linecap="round"/>
            </g>

            <!-- nuki (horizontal tie) -->
            <path d="M160 190 C270 160, 590 160, 700 190 L690 225 C585 200, 275 200, 170 225 Z" fill="url(#gRed)" stroke="rgba(255,255,255,.12)" stroke-width="5"/>

            <!-- pillars -->
            <g>
              <path d="M208 152 C220 250, 222 302, 220 338 L164 338 C160 298, 160 250, 170 152 Z" fill="url(#gRed)" stroke="rgba(255,255,255,.14)" stroke-width="6"/>
              <path d="M690 152 C680 250, 678 302, 680 338 L736 338 C740 298, 740 250, 730 152 Z" fill="url(#gRed)" stroke="rgba(255,255,255,.14)" stroke-width="6"/>
              <!-- base shoes -->
              <path d="M148 338 H236 L248 355 H136 Z" fill="#160404" stroke="rgba(255,255,255,.12)" stroke-width="4"/>
              <path d="M624 338 H712 L724 355 H612 Z" fill="#160404" stroke="rgba(255,255,255,.12)" stroke-width="4"/>
            </g>

            <!-- subtle shine -->
            <path d="M120 70 C240 32, 620 32, 740 70" stroke="url(#gShade)" stroke-width="10" stroke-linecap="round" opacity=".55"/>
          </svg>
        </div>

        <div class="cdz">
          <div>
            <div class="cdzTitle">⚡ Referência CDZ</div>
            <div class="cdzSmall">Treino diário → “armadura” mental. Sem emoção no risco: só execução.</div>
          </div>
          <div class="spark" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </section>

  <div class="grid">
    <!-- Game -->
    <section class="card">
      <div class="cardHeader">
        <h2>Jogo — Adivinhe o Kanji</h2>
        <div class="meta">Score: <span id="score">0</span> · Streak: <span id="streak">0</span></div>
      </div>
      <div class="cardBody">
        <h3 class="bigKanji" id="bigKanji">日</h3>
        <p class="prompt" id="prompt">Escolha o significado correto (PT) ou clique em <b>Revelar</b>.</p>

        <div class="choices" id="choices"></div>

        <div class="statusRow">
          <div class="stat">Nível: <span id="level">N5</span></div>
          <div class="stat">Foco: <span id="focus">Significado</span></div>
          <div class="stat">Atalho: Space / Enter / P</div>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </section>

    <!-- Vocabulary -->
    <section class="card">
      <div class="cardHeader">
        <h2>Vocabulário (com leitura + significado)</h2>
        <div class="meta">N5 / N4 — comum e cotidiano</div>
      </div>
      <div class="cardBody">
        <div class="tabs">
          <button class="primary" id="tabN5">N5</button>
          <button id="tabN4">N4</button>
        </div>
        <div class="vlist" id="vlist"></div>
      </div>
    </section>
  </div>

  <div class="foot">Dica: disciplina &gt; “overtrade”. Revisão (P) antes de acelerar.</div>
</div>

<!-- Review Modal -->
<div class="overlay" id="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Revisão">
    <div class="modalHead">
      <div class="title">Revisão rápida</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="badge" id="reviewMeta">0 itens</div>
        <button id="btnCloseReview">Fechar (Esc)</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="reviewGrid" id="reviewGrid"></div>
    </div>
  </div>
</div>

<script>
/* =========================
   THEME HUE (5s)
========================= */
(function themeCycle(){
  const root = document.documentElement;
  let hue = parseFloat(getComputedStyle(root).getPropertyValue('--themeHue')) || 195;
  setInterval(()=>{
    hue = (hue + 27) % 360;
    root.style.setProperty('--themeHue', hue.toFixed(0));
  }, 5000);
})();

/* =========================
   DATA (N5 / N4)
========================= */
const DATA = {
  N5: [
    {k:'日', r:'にち / ひ', m:'dia; sol', v:['日本（にほん）= Japão','毎日（まいにち）= todo dia','休日（きゅうじつ）= feriado']},
    {k:'人', r:'ひと / じん', m:'pessoa', v:['日本人（にほんじん）= japonês','大人（おとな）= adulto','一人（ひとり）= uma pessoa']},
    {k:'水', r:'みず / すい', m:'água', v:['水曜日（すいようび）= quarta','お水（おみず）= água (polido)','水道（すいどう）= encanamento']},
    {k:'山', r:'やま / さん', m:'montanha', v:['富士山（ふじさん）= Monte Fuji','山道（やまみち）= caminho na montanha','火山（かざん）= vulcão']},
    {k:'大', r:'おお / だい', m:'grande', v:['大学（だいがく）= universidade','大丈夫（だいじょうぶ）= tudo bem','大人（おとな）= adulto']},
    {k:'小', r:'ちい / しょう', m:'pequeno', v:['小さい（ちいさい）= pequeno','小学生（しょうがくせい）= aluno do fundamental','小川（おがわ）= riacho']},
    {k:'行', r:'い(く) / こう', m:'ir; ação', v:['行く（いく）= ir','銀行（ぎんこう）= banco','旅行（りょこう）= viagem']},
    {k:'見', r:'み(る) / けん', m:'ver', v:['見る（みる）= ver','意見（いけん）= opinião','見学（けんがく）= visita de estudo']},
  ],
  N4: [
    {k:'無', r:'む', m:'não; sem', v:['無料（むりょう）= grátis','無理（むり）= impossível; forçar','無事（ぶじ）= em segurança']},
    {k:'常', r:'じょう', m:'normal; constante', v:['日常（にちじょう）= cotidiano','通常（つうじょう）= normal','非常（ひじょう）= emergência']},
    {k:'取', r:'と(る)', m:'pegar; obter', v:['取る（とる）= pegar','受け取る（うけとる）= receber','取り返す（とりかえす）= recuperar']},
    {k:'決', r:'き(める) / けつ', m:'decidir', v:['決める（きめる）= decidir','決定（けってい）= decisão','解決（かいけつ）= solução']},
    {k:'続', r:'つづ(く)', m:'continuar', v:['続く（つづく）= continuar','続ける（つづける）= continuar (algo)','連続（れんぞく）= sequência']},
    {k:'変', r:'へん / か(える)', m:'mudar; estranho', v:['変える（かえる）= mudar','変化（へんか）= mudança','大変（たいへん）= difícil; sério']},
    {k:'思', r:'おも(う)', m:'pensar; achar', v:['思う（おもう）= pensar','不思議（ふしぎ）= misterioso','意思（いし）= vontade']},
    {k:'感', r:'かん', m:'sentir; sensação', v:['感じる（かんじる）= sentir','感情（かんじょう）= emoção','共感（きょうかん）= empatia']},
  ]
};

/* =========================
   GAME LOGIC
========================= */
let currentLevel = 'N5';
let score = 0;
let streak = 0;
let currentIndex = 0;
let revealed = false;

const bigKanji = document.getElementById('bigKanji');
const choicesEl = document.getElementById('choices');
const toast = document.getElementById('toast');

const scoreEl = document.getElementById('score');
const streakEl = document.getElementById('streak');
const levelEl = document.getElementById('level');

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function setToast(msg, good=null){
  toast.textContent = msg;
  toast.classList.remove('show','good','bad');
  toast.classList.add('show');
  if(good===true) toast.classList.add('good');
  if(good===false) toast.classList.add('bad');
  clearTimeout(setToast._t);
  setToast._t = setTimeout(()=>toast.classList.remove('show'), 1400);
}

function buildChoices(item){
  // build 4 options (1 correct + 3 decoys from same level)
  const pool = DATA[currentLevel];
  const others = shuffle(pool.filter(x=>x.k !== item.k)).slice(0,3);
  const options = shuffle([item, ...others]);

  choicesEl.innerHTML = '';
  options.forEach(opt=>{
    const div = document.createElement('div');
    div.className = 'choice';
    div.innerHTML = `
      <div class="jp">${opt.m}</div>
      <div class="pt">${opt.k} ・ ${opt.r}</div>
    `;
    div.addEventListener('click', ()=> choose(opt, item));
    choicesEl.appendChild(div);
  });
}

function render(){
  const pool = DATA[currentLevel];
  if(!pool.length) return;

  currentIndex = (currentIndex + pool.length) % pool.length;
  const item = pool[currentIndex];
  revealed = false;

  bigKanji.textContent = item.k;
  buildChoices(item);
  levelEl.textContent = currentLevel;
}

function reveal(){
  const item = DATA[currentLevel][currentIndex];
  if(!item) return;
  revealed = true;
  setToast(`答え: ${item.k}（${item.r}）= ${item.m}`, true);
}

function choose(opt, correct){
  if(!correct) return;
  if(opt.k === correct.k){
    score += 10;
    streak += 1;
    setToast(`✅ Acertou: ${correct.k} = ${correct.m}`, true);
  } else {
    streak = 0;
    setToast(`❌ Era: ${correct.k}（${correct.r}）= ${correct.m}`, false);
  }
  scoreEl.textContent = score;
  streakEl.textContent = streak;
  // next
  setTimeout(next, 320);
}

function next(){
  currentIndex++;
  render();
}

function resetAll(){
  score = 0; streak = 0; currentIndex = 0;
  scoreEl.textContent = score;
  streakEl.textContent = streak;
  render();
}

/* =========================
   VOCAB UI
========================= */
const vlist = document.getElementById('vlist');
const tabN5 = document.getElementById('tabN5');
const tabN4 = document.getElementById('tabN4');

function renderVocab(level){
  currentLevel = level;
  tabN5.classList.toggle('primary', level==='N5');
  tabN4.classList.toggle('primary', level==='N4');

  const items = DATA[level];
  vlist.innerHTML = '';
  items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'vitem';
    div.innerHTML = `
      <div class="vtop">
        <div class="vkanji">${it.k}</div>
        <div class="vreading">${it.r}</div>
      </div>
      <div class="vmeaning"><b>Significado:</b> ${it.m}</div>
      <div class="vocabs">
        ${it.v.slice(0,3).map(x=>`<span class="vchip">${x}</span>`).join('')}
      </div>
    `;
    vlist.appendChild(div);
  });

  // keep game in same level
  render();
}

tabN5.addEventListener('click', ()=>renderVocab('N5'));
tabN4.addEventListener('click', ()=>renderVocab('N4'));

/* =========================
   REVIEW MODAL (não trava)
========================= */
const overlay = document.getElementById('overlay');
const reviewGrid = document.getElementById('reviewGrid');
const reviewMeta = document.getElementById('reviewMeta');
const btnCloseReview = document.getElementById('btnCloseReview');

function openReview(){
  // monta com os 8 primeiros do nível atual (rápido, leve)
  const items = DATA[currentLevel].slice(0, 8);
  reviewGrid.innerHTML = '';
  items.forEach(it=>{
    const c = document.createElement('div');
    c.className = 'reviewCard';
    c.innerHTML = `
      <div class="k">${it.k}</div>
      <div class="r">${it.r}</div>
      <div class="m">${it.m}</div>
    `;
    reviewGrid.appendChild(c);
  });
  reviewMeta.textContent = `${items.length} itens`;
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}
function closeReview(){
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
}

btnCloseReview.addEventListener('click', closeReview);
overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeReview(); });

/* =========================
   BUTTONS + HOTKEYS
========================= */
document.getElementById('btnNext').addEventListener('click', next);
document.getElementById('btnReveal').addEventListener('click', reveal);
document.getElementById('btnReview').addEventListener('click', openReview);
document.getElementById('btnReset').addEventListener('click', resetAll);

document.addEventListener('keydown', (e)=>{
  // Não “cair”/travar com P:
  if(e.key === 'p' || e.key === 'P'){
    e.preventDefault();
    if(overlay.classList.contains('show')) closeReview();
    else openReview();
    return;
  }
  if(e.key === 'Escape'){
    if(overlay.classList.contains('show')) closeReview();
    return;
  }
  if(e.key === ' '){
    e.preventDefault();
    if(overlay.classList.contains('show')) return; // não troca por baixo do modal
    next();
    return;
  }
  if(e.key === 'Enter'){
    e.preventDefault();
    if(overlay.classList.contains('show')) return;
    reveal();
    return;
  }
});

/* =========================
   KANJI RAIN (moderada)
========================= */
const canvas = document.getElementById('rain');
const ctx = canvas.getContext('2d');

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const glyphs = "無常日月火水木金土山川人心空夢夜雨影光愛学語道".split('');
let cols = [];
function initRain(){
  const fontSize = 18;
  const columnCount = Math.floor(canvas.width / fontSize);
  cols = Array.from({length: columnCount}, ()=>({
    y: Math.random()*canvas.height,
    speed: 0.7 + Math.random()*1.2,   // moderado
    g: glyphs[Math.floor(Math.random()*glyphs.length)],
    font: fontSize
  }));
}
initRain();

function drawRain(){
  ctx.fillStyle = "rgba(0,0,0,0.12)";
  ctx.fillRect(0,0,canvas.width, canvas.height);

  const hue = getComputedStyle(document.documentElement).getPropertyValue('--themeHue').trim() || '195';
  ctx.font = "18px 'Noto Sans JP', system-ui";
  cols.forEach((c, i)=>{
    const x = i * 18;
    const y = c.y;

    ctx.fillStyle = `hsla(${hue}, 90%, 70%, 0.55)`;
    ctx.fillText(c.g, x, y);

    c.y += c.speed*18;
    if(c.y > canvas.height + 40){
      c.y = -Math.random()*200;
      c.speed = 0.7 + Math.random()*1.2;
      c.g = glyphs[Math.floor(Math.random()*glyphs.length)];
    }
    // troca ocasional
    if(Math.random() < 0.03){
      c.g = glyphs[Math.floor(Math.random()*glyphs.length)];
    }
  });

  requestAnimationFrame(drawRain);
}
drawRain();

/* =========================
   START
========================= */
renderVocab('N5');  // inicial N5
resetAll();
</script>
</body>
</html>
